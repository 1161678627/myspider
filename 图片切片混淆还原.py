# author:  ZhaoKun
# contact: 1161678627@qq.com
# datetime:2020-07-17 20:52
# software: PyCharm

import requests
import re
from PIL import Image

def get_pic():
    confusion_pic_url = 'http://passport.51.com/yzm/pic_temp/code/2020082402/big/e06f26b9fcda4e9572d2a505986d745f.png'
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36'
    }
    confusion_pic = requests.get(url=confusion_pic_url, headers=headers).content
    with open('./confusion_pic.jpg','wb') as f:
        f.write(confusion_pic)

def parse_background_position_html():
    # 背景定位脚本不一定唯一，每次请求都会变化
    background_position_url = 'http://passport.51.com/authcode/slidecode?callback=jQuery111108379698242511875_1598203766425&from=box&pic_type=mobileLogin&divpre=only_&_=1598203766437'
    headers = {
        'Cookie': 'FO_RFLP=%7CaHR0cDovL3d3dy41MS5jb20v%7C%7C%7C;FO_TUID=FsXDld;5f429282a51df=1598200135_ec2751745163ad26caa166b1e6a579ec;PHPSESSID=6sb5m13i0tbv3md92hbqr4olg7;Hm_lvt_940aa8668c1606e3733aded32f601d5d=1598200136;Hm_lpvt_940aa8668c1606e3733aded32f601d5d=1598200136',
        'Host': 'passport.51.com',
        'Origin': 'http://passport.51.com',
        'Referer': 'http://passport.51.com/login/proxy',
        'User-Agent': 'Mozilla/5.0(WindowsNT10.0;Win64;x64)AppleWebKit/537.36(KHTML,likeGecko)Chrome/84.0.4147.135Safari/537.36'
    }
    res = requests.get(url=background_position_url, headers=headers).content.decode()
    res = r'''
    jQuery111102901198391828652_1598206437883({"errno":0,"error":"","data":"        \n<style>\n                #only_drag {\n                position: relative;\n                background-color: #e8e8e8;\n                height: 34px;\n                line-height: 34px;\n                left: 90px;            }\n            .gt_cut_fullbg_slice {\n                float: left;\n                width: 13px;\n                height: 25px;\n                margin: 0 !important;\n                border: 0px;\n                padding: 0 !important;\n                background-image: url(\"\/\/passport.51.com\/yzm\/pic_temp\/code\/2020082402\/big\/e06f26b9fcda4e9572d2a505986d745f.png\");\n            }\n            .xy_img_bord{\n                -webkit-box-shadow:0 0 15px #0CC;\n                -moz-box-shadow:0 0 15px #0CC;\n                box-shadow:0 0 15px #0CC;\n            }\n            #only_xy_img{\n                background-image: url(\/\/passport.51.com\/yzm\/pic_temp\/code\/2020082402\/small\/e1149125a6a1304a57d25feddf237639.png);z-index: 999;width: 27px;height:29px;position:absolute;\n            }\n            #only_drag .drag_bg {\n                background-color: #7ac23c;\n                height: 34px;\n                width: 0px;\n            }\n            #only_drag .handler {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 40px;\n                height: 32px;\n                border: 1px solid #ccc;\n                cursor: move;\n            }\n            .handler_bg {\n                background: #fff url(\"\/\/cdn.51img1.com\/v6\/yzm\/51\/slide\/img\/slide.png\") no-repeat center;\n            }\n            #only_drag .drag_text {\n                position: absolute;\n                top: 0px;\n                width: 265px;\n                text-align: center;\n                -moz-user-select: none;\n                -webkit-user-select: none;\n                user-select: none;\n                -o-user-select: none;\n                -ms-user-select: none;\n            }\n        <\/style>\n            <div class=\"row put_val\" >\n                \n                <div style=\"width: 260px;height: 116px; position: absolute;display: none;top: 39px;left: 136px;\" id=\"only_Verification\" >\n                    <div class='gt_cut_fullbg_slice' style='background-position:-221px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-169px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-117px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-221px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-156px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-208px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-143px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-52px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-26px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-91px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-104px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:0px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-247px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-208px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-234px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-104px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-117px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-130px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-117px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-39px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-182px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-221px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-91px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-13px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-195px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-13px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-143px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-104px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-78px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-65px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-234px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-195px -25px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-65px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-78px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:0px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-156px -75px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-247px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-247px -50px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-13px 0px;'><\/div><div class='gt_cut_fullbg_slice' style='background-position:-234px 0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-78px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-52px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-26px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-247px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-143px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-169px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-195px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-117px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-39px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:0px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-52px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-39px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-169px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-182px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-130px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:0px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-104px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-65px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-182px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-26px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-195px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-130px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-52px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-143px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-39px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-156px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-13px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-221px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-130px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-26px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-208px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-234px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-169px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-208px  -75px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-182px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-91px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-91px  -25px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-78px  0px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-156px  -50px;'><\/div><div  class='gt_cut_fullbg_slice' style='background-position:-65px  -50px;'><\/div>\n                    <div style=\"top: 59px;left: 0px;display: none;border: 1px solid white\" id=\"only_xy_img\" class=\"xy_img_bord\"><\/div>\n                <\/div>\n                <div id=\"only_drag\" style=\"width: 260px;\">\n                    <div class=\"drag_bg\"><\/div>\n                <div class=\"drag_text\" onselectstart=\"return false;\" unselectable=\"on\">\u62d6\u52a8\u56fe\u7247\u9a8c\u8bc1\u767b\u9646<\/div>\n                <div class=\"handler handler_bg\"><\/div>\n                <\/div>\n            <\/div>\n        <input type=\"hidden\" id=\"only_challenge\" value=\"09c10f58183e591582bf40c50ca8ee6d\">\n        <input type=\"hidden\" id=\"only_times\" value=\"1598206445\">\n        <input type=\"hidden\" id=\"only_frame_login_authcode\" class=\"t\" type=\"text\" value=\"\" \/>"});
    '''
    pattern = re.compile(r"style='background-position:(.*?);'>")
    position_list = pattern.findall(res)
    position_x_list = [int(__.replace('  ',' ').replace('px','').split(' ')[0]) for __ in position_list]
    position_y_list = [int(__.replace('  ',' ').replace('px','').split(' ')[1]) for __ in position_list]
    return position_x_list, position_y_list

def get_original_pic(position_x_list, position_y_list):
    one_img_list = [position_x_list[0:20], position_y_list[0:20]]
    two_img_list = [position_x_list[20:40], position_y_list[20:40]]
    three_img_list = [position_x_list[40:60], position_y_list[40:60]]
    four_img_list = [position_x_list[60:80], position_y_list[60:80]]
    confusion_pic = Image.open('./confusion_pic.jpg')
    # 将该图片按照大小进行切割，切割为4部分
    # 经过坐标观察本例中将大图分成了 13*25大小的80个子图，原始图为260 * 100，直接按照顺序排序还原即可
    all_img_list = [one_img_list, two_img_list, three_img_list, four_img_list]
    original_img = Image.new('RGB', (260, 100))
    for rel_y in range(len(all_img_list)):
        for rel_x in range(len(all_img_list[rel_y][0])):
            location_x = all_img_list[rel_y][0][rel_x]
            location_y = all_img_list[rel_y][1][rel_x]
            original_img.paste(confusion_pic.crop((abs(location_x), abs(location_y), abs(location_x) + 13, abs(location_y) + 25)) ,(rel_x*13, rel_y*25))
    original_img.show()

if __name__ == '__main__':
    get_pic()
    position_x_list, position_y_list = parse_background_position_html()
    get_original_pic(position_x_list, position_y_list)


